<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Camion;
use Illuminate\Http\Request;

class CamionController extends Controller
{
    public function index(Request $request)
    {
        $q        = $request->query('q');          // bÃºsqueda
        $turnoId  = $request->query('turno_id');   // filtrar camiones por turno
        $perPage  = (int) $request->integer('per_page', 0);

        $query = Camion::query()
            ->with(['turno', 'usuario'])
            ->orderBy('id');

        // ðŸ” Scope de bÃºsqueda (nom_linea LIKE %q%)
        if (!empty($q)) {
            $query->buscar($q);
        }

        // ðŸ”¹ Filtrar por turno usando el scope porTurno del modelo
        if (!empty($turnoId)) {
            $query->porTurno($turnoId);
        }

        // ðŸ”¹ Si viene paginaciÃ³n
        if ($perPage > 0) {
            $p = $query->paginate($perPage);

            return response()->json([
                'ok'   => true,
                'data' => $p->items(),
                'meta' => [
                    'current_page' => $p->currentPage(),
                    'last_page'    => $p->lastPage(),
                    'per_page'     => $p->perPage(),
                    'total'        => $p->total(),
                ],
            ]);
        }

        // ðŸ”¹ Sin paginaciÃ³n
        $items = $query->get();

        return response()->json([
            'ok'   => true,
            'data' => $items,
        ]);
    }

    public function store(Request $request)
    {
        $data = $request->validate([
            'nom_linea'  => ['required', 'string', 'max:255'],
            'id_turno'   => ['required', 'integer', 'exists:turnos,id'],
            'id_usuario' => ['nullable', 'integer', 'exists:usuarios,id'],
        ]);

        $camion = Camion::create($data);

        // Cargar relaciones para que Flutter reciba todo completo
        $camion->load(['turno', 'usuario']);

        return response()->json([
            'ok'   => true,
            'data' => $camion,
        ], 201);
    }

    public function show($id)
    {
        $camion = Camion::with(['turno', 'usuario'])->find($id);

        if (!$camion) {
            return response()->json([
                'ok'      => false,
                'message' => 'No encontrado',
            ], 404);
        }

        return response()->json([
            'ok'   => true,
            'data' => $camion,
        ]);
    }

    public function update(Request $request, $id)
    {
        $camion = Camion::find($id);

        if (!$camion) {
            return response()->json([
                'ok'      => false,
                'message' => 'No encontrado',
            ], 404);
        }

        $data = $request->validate([
            'nom_linea'  => ['sometimes', 'required', 'string', 'max:255'],
            'id_turno'   => ['sometimes', 'required', 'integer', 'exists:turnos,id'],
            'id_usuario' => ['sometimes', 'nullable', 'integer', 'exists:usuarios,id'],
        ]);

        $camion->update($data);
        $camion->load(['turno', 'usuario']);

        return response()->json([
            'ok'   => true,
            'data' => $camion,
        ]);
    }

    public function destroy($id)
    {
        $camion = Camion::find($id);

        if (!$camion) {
            return response()->json([
                'ok'      => false,
                'message' => 'No encontrado',
            ], 404);
        }

        $deletedId = $camion->id;
        $camion->delete();

        return response()->json([
            'ok'      => true,
            'message' => 'Eliminado',
            'id'      => $deletedId,
        ]);
    }
}
